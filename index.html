<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Undergrad Topic Booking</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f5f5f5; color: #333; line-height: 1.6; padding: 20px;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    .header { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,.1); }
    .header h1 { font-size: 24px; color: #2563eb; margin-bottom: 6px; }
    .header p { color: #666; margin-bottom: 12px; }
    .card { background:#fff; padding:20px; border-radius:8px; margin-bottom:20px; box-shadow:0 2px 4px rgba(0,0,0,.08); }
    .card h2 { font-size: 18px; margin-bottom: 12px; }
    .form-group { margin-bottom: 12px; }
    .form-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width: 768px){ .form-row{ grid-template-columns:1fr; } }
    label { display:block; margin-bottom:6px; font-weight:500; }
    input, textarea, select {
      width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; font-size:14px;
    }
    input:focus, textarea:focus, select:focus { outline:none; border-color:#2563eb; }
    input.error { border-color:#ef4444; }
    .error-message { color:#ef4444; font-size:12px; margin-top:4px; }
    textarea { resize: vertical; min-height: 84px; }
    .btn { background:#2563eb; color:#fff; border:none; padding:12px 16px; border-radius:6px; cursor:pointer; font-size:14px; font-weight:600; }
    .btn:hover { background:#1d4ed8; }
    .btn-secondary { background:#6b7280; }
    .btn-secondary:hover { background:#4b5563; }
    .btn:disabled { background:#94a3b8; cursor:not-allowed; }
    .btn-full { width:100%; }
    .status { padding:8px 10px; border-radius:6px; font-size:13px; display:inline-flex; align-items:center; gap:6px; font-weight:600; }
    .status-success { background:#dcfce7; color:#166534; }
    .status-error { background:#fee2e2; color:#991b1b; }
    .status-warning { background:#fef3c7; color:#92400e; }
    .status-info { background:#e0f2fe; color:#075985; }
    .layout { display:grid; grid-template-columns:400px 1fr; gap:20px; }
    @media (max-width: 1024px){ .layout{ grid-template-columns:1fr; } }
    .hidden { display:none; }
    table { width:100%; border-collapse: collapse; margin-top: 10px; }
    th { background:#f8f9fa; text-align:left; padding:10px; border-bottom:2px solid #e5e7eb; }
    td { padding:10px; border-bottom:1px solid #e5e7eb; vertical-align: top; }
    tr:hover { background:#fafafa; }
    .filters { display:flex; gap:10px; margin-bottom:10px; flex-wrap: wrap; }
    .loading { text-align:center; padding:20px; color:#666; }
    .empty-state { text-align:center; padding:40px 20px; color:#666; }
    .spinner { display:inline-block; width:16px; height:16px; border:2px solid #f3f3f3; border-top:2px solid #2563eb; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin{ to{ transform: rotate(360deg); } }
    .conflicts { margin-top: 12px; display: grid; gap:10px; }
    .conflict-item { border:1px solid #e5e7eb; border-radius:8px; padding:12px; background:#f9fafb; }
    .conflict-top { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; }
    .badge { font-size:11px; padding:4px 8px; border-radius:999px; font-weight:700; }
    .b-exact { background:#fee2e2; color:#991b1b; }
    .b-high { background:#ffedd5; color:#9a3412; }
    .b-med { background:#e0f2fe; color:#075985; }
    .b-low { background:#e9d5ff; color:#6b21a8; }
    .scorebar { height:6px; background:#e5e7eb; border-radius:999px; overflow:hidden; }
    .scorebar > span { display:block; height:100%; background:#2563eb; width:0%; }
    .small { font-size:12px; color:#555; }
    code { background:#f3f4f6; padding:2px 4px; border-radius:4px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Undergrad Topic Booking</h1>
      <p>Manage student research topics with clear conflict checks on <strong>Title</strong>, <strong>Dataset</strong>, and <strong>Goal</strong>.</p>
      <button id="refreshBtn" class="btn btn-secondary">‚Üª Refresh Data</button>
    </div>

    <div class="layout">
      <!-- Left column -->
      <div>
        <!-- Check Section -->
        <div class="card">
          <h2>Check Availability</h2>

          <div class="form-row">
            <div class="form-group">
              <label>Student Name</label>
              <input id="studentName" placeholder="e.g., Alex" />
            </div>
            <div class="form-group">
              <label>Student ID (CDU)</label>
              <input id="studentId" placeholder="2021xxxxxxxx" maxlength="12" />
              <div id="studentIdError" class="error-message hidden">Student ID must be 12 digits starting with 2021</div>
            </div>
          </div>

          <div class="form-group">
            <label>Topic Title</label>
            <input id="topicTitle" placeholder="Short descriptive title" />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Dataset Name</label>
              <input id="dataset" placeholder="e.g., UCI Credit" />
            </div>
            <div class="form-group">
              <label>Dataset URL</label>
              <input id="datasetLink" type="url" placeholder="https://..." />
            </div>
          </div>

          <div class="form-group">
            <label>Research Goal</label>
            <textarea id="goal" placeholder="Describe the research objective"></textarea>
          </div>

          <div class="form-group">
            <label>Supervisor</label>
            <select id="teacher">
              <option value="">Select Supervisor</option>
              <option value="Cezar">Cezar</option>
              <option value="Gladys">Gladys</option>
              <option value="IJ">IJ</option>
              <option value="Isaac">Isaac</option>
              <option value="James">James</option>
              <option value="Javed">Javed</option>
              <option value="Joao">Joao</option>
              <option value="Linda">Linda</option>
              <option value="Martin">Martin</option>
              <option value="Meropi">Meropi</option>
              <option value="Pedro">Pedro</option>
              <option value="Stacy">Stacy</option>
              <option value="Taha">Taha</option>
              <option value="Yuefei">Yuefei</option>
              <option value="Zaid">Zaid</option>
            </select>
          </div>

          <button id="checkBtn" class="btn btn-full">Check Availability</button>

          <div id="checkResult" class="hidden" style="margin-top:12px;">
            <div id="availabilitySummary" style="margin-bottom:8px;"></div>
            <div id="availabilityNote" style="margin-bottom:6px;"></div>
            <div id="conflicts" class="conflicts"></div>
          </div>
        </div>

        <!-- Add Section -->
        <div class="card">
          <h2>Add Booking</h2>
          <p class="small" style="margin-bottom: 10px;">Submit your topic if it's available.</p>
          <button id="addBtn" class="btn btn-full">Add to Sheet</button>
          <div id="addStatus" style="margin-top: 10px; text-align: center;"></div>
        </div>
      </div>

      <!-- Right column -->
      <div class="card">
        <h2>Current Bookings</h2>
        <div class="filters">
          <input id="filterText" placeholder="Search..." />
          <input id="filterTeacher" placeholder="Filter by Teacher" />
          <button id="clearFilters" class="btn btn-secondary">Clear</button>
        </div>
        <div style="overflow-x:auto;">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Student</th>
                <th>Topic</th>
                <th>Dataset</th>
                <th>Goal</th>
                <th>Teacher</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxv7iau-cZ0iF29D3EaFehf0q5xoBJ2iOV0O7Pz2R_-bxRZDnt3S9DY1-jGDtiK0iKaLg/exec';
    const API_TOKEN = 'my-secret-123';

    // Sheet column mapping constants
    const SHEET_COLUMNS = {
      STUDENT_NAME: 'StudentName',
      STUDENT_ID: 'StudentID',
      TOPIC_TITLE: 'TopicTitle',
      DATASET_NAME: 'Dataset Name',    // note spaces
      DATASET_LINK: 'Dataset Link',    // note spaces
      GOAL: 'Goal',
      TEACHER: 'Teacher',
      STATUS: 'Status',
      TIMESTAMP: 'Timestamp'
    };

    // ====== ELEMENTS ======
    const input = {
      studentName: document.getElementById('studentName'),
      studentId: document.getElementById('studentId'),
      topicTitle: document.getElementById('topicTitle'),
      dataset: document.getElementById('dataset'),
      datasetLink: document.getElementById('datasetLink'),
      goal: document.getElementById('goal'),
      teacher: document.getElementById('teacher'),
    };

    const checkBtn = document.getElementById('checkBtn');
    const checkResult = document.getElementById('checkResult');
    const availabilityNote = document.getElementById('availabilityNote');
    const availabilitySummary = document.getElementById('availabilitySummary');
    const conflictsBox = document.getElementById('conflicts');
    const addBtn = document.getElementById('addBtn');
    const addStatus = document.getElementById('addStatus');
    const filterText = document.getElementById('filterText');
    const filterTeacher = document.getElementById('filterTeacher');
    const clearFilters = document.getElementById('clearFilters');
    const rowsTbody = document.getElementById('rows');
    const studentIdError = document.getElementById('studentIdError');

    let allRows = [];

    // ====== HELPERS (text processing, similarity) ======
    const STOPWORDS = new Set([
      // English
      'the','a','an','of','and','or','to','for','with','on','in','by','from','at','as','is','are','be','this','that','these','those','using','use','based',
      'data','dataset','study','analysis','method','methods','approach','model','models','towards','into','via','over','under','within','about',
      // Arabic (small set)
      'ŸÅŸä','ÿπŸÑŸâ','ÿπŸÜ','ŸÖŸÜ','ÿ•ŸÑŸâ','ÿßŸÑŸâ','ŸÖÿπ','Ÿáÿ∞ÿß','Ÿáÿ∞Ÿá','ÿ∞ŸÑŸÉ','ÿ™ŸÑŸÉ','Ÿà','ÿ£Ÿà','ÿßŸà','ÿ£ŸÜ','ÿ•ŸÜ','ŸÉÿßŸÜ','ŸÉÿßŸÜÿ™','ŸáŸà','ŸáŸä','ÿ∂ŸÖŸÜ','ÿ≠ŸàŸÑ'
    ]);

    function normalize(str='') {
      return (str || '')
        .toLowerCase()
        .replace(/https?:\/\/(www\.)?/g,'') // drop scheme for URL compare
        .replace(/[^\p{L}\p{N}\s./_-]+/gu,'') // keep letters/numbers/space and some URL chars
        .replace(/\s+/g,' ')
        .trim();
    }

    function tokens(str='') {
      const n = normalize(str);
      return n.split(/\s+/).filter(t => t && !STOPWORDS.has(t));
    }

    function jaccard(a, b) {
      const A = new Set(tokens(a)), B = new Set(tokens(b));
      if (A.size === 0 && B.size === 0) return 1;
      let inter = 0;
      for (const x of A) if (B.has(x)) inter++;
      const uni = A.size + B.size - inter;
      return uni ? inter / uni : 0;
    }

    function levenshtein(a, b) {
      a = normalize(a); b = normalize(b);
      const m = a.length, n = b.length;
      if (m === 0) return n;
      if (n === 0) return m;
      const dp = Array.from({length:m+1},()=>Array(n+1).fill(0));
      for (let i=0;i<=m;i++) dp[i][0]=i;
      for (let j=0;j<=n;j++) dp[0][j]=j;
      for (let i=1;i<=m;i++){
        for (let j=1;j<=n;j++){
          const cost = a[i-1]===b[j-1]?0:1;
          dp[i][j]=Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
        }
      }
      return dp[m][n];
    }

    function ratioFromDistance(a, b) {
      const dist = levenshtein(a,b);
      const maxLen = Math.max(normalize(a).length, normalize(b).length) || 1;
      return 1 - (dist / maxLen);
    }

    function sameUrl(u1='', u2='') {
      const A = normalize(u1).replace(/\/+$/,''); // trim trailing slash
      const B = normalize(u2).replace(/\/+$/,'');
      return A && B && A === B;
    }

    function sameDomain(u1='', u2='') {
      try {
        const d1 = new URL(u1).hostname.replace(/^www\./,'');
        const d2 = new URL(u2).hostname.replace(/^www\./,'');
        return d1 && d2 && d1 === d2;
      } catch { return false; }
    }

    function pct(x) { return Math.round(x*100); }

    function severityBadge(level){
      if (level==='exact') return '<span class="badge b-exact">EXACT</span>';
      if (level==='high') return '<span class="badge b-high">HIGH</span>';
      if (level==='medium') return '<span class="badge b-med">MED</span>';
      return '<span class="badge b-low">LOW</span>';
    }

    function scorebar(s) {
      const w = Math.round(Math.max(0, Math.min(100, s)));
      return `<div class="scorebar"><span style="width:${w}%"></span></div>`;
    }

    // ====== VALIDATION ======
    function validateStudentId(value) {
      const pattern = /^2021\\d{8}$/;
      return pattern.test(value);
    }
    input.studentId.addEventListener('input', function(){
      const value = this.value.trim();
      if (value && !validateStudentId(value)) { this.classList.add('error'); studentIdError.classList.remove('hidden'); }
      else { this.classList.remove('error'); studentIdError.classList.add('hidden'); }
    });

    // ====== DATA FETCH & RENDER ======
    document.getElementById('refreshBtn').addEventListener('click', loadRows);
    clearFilters.addEventListener('click', () => { filterText.value=''; filterTeacher.value=''; renderRows(); });
    filterText.addEventListener('input', renderRows);
    filterTeacher.addEventListener('input', renderRows);

    checkBtn.addEventListener('click', checkAvailability);
    addBtn.addEventListener('click', addBooking);

    async function loadRows() {
      rowsTbody.innerHTML = '<tr><td colspan="7" class="loading">Loading...</td></tr>';
      try {
        const url = `${SCRIPT_URL}?action=list&token=${encodeURIComponent(API_TOKEN)}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        const data = await res.json();
        if (data.error) throw new Error(data.error);

        allRows = (data.rows || []).map((r, idx) => ({
          idx,
          Timestamp: r[SHEET_COLUMNS.TIMESTAMP] ? new Date(r[SHEET_COLUMNS.TIMESTAMP]) : '',
          StudentName: r[SHEET_COLUMNS.STUDENT_NAME] || '',
          StudentID: r[SHEET_COLUMNS.STUDENT_ID] || '',
          TopicTitle: r[SHEET_COLUMNS.TOPIC_TITLE] || '',
          Dataset: r[SHEET_COLUMNS.DATASET_NAME] || '',
          DatasetLink: r[SHEET_COLUMNS.DATASET_LINK] || '',
          Goal: r[SHEET_COLUMNS.GOAL] || '',
          Teacher: r[SHEET_COLUMNS.TEACHER] || '',
          Status: r[SHEET_COLUMNS.STATUS] || 'Booked'
        }));

        renderRows();
      } catch (err) {
        rowsTbody.innerHTML = `<tr><td colspan="7" class="loading" style="color:#b91c1c;">Error: ${err.message}</td></tr>`;
      }
    }

    function renderRows() {
      const searchText = (filterText.value || '').toLowerCase();
      const teacherFilter = (filterTeacher.value || '').toLowerCase();
      const filtered = allRows.filter(r => {
        const blob = `${r.StudentName} ${r.TopicTitle} ${r.Dataset} ${r.Goal} ${r.Teacher}`.toLowerCase();
        const ok1 = !searchText || blob.includes(searchText);
        const ok2 = !teacherFilter || r.Teacher.toLowerCase().includes(teacherFilter);
        return ok1 && ok2;
      });

      if (!filtered.length) {
        rowsTbody.innerHTML = '<tr><td colspan="7" class="empty-state">No bookings found</td></tr>';
        return;
      }

      rowsTbody.innerHTML = filtered.map((r,i)=>`
        <tr>
          <td>${i+1}</td>
          <td>
            <div style="font-weight:600">${escapeHtml(r.StudentName)}</div>
            <div class="small">ID: ${escapeHtml(r.StudentID)}</div>
          </td>
          <td>${escapeHtml(r.TopicTitle)}</td>
          <td>
            <div style="font-weight:600; color:#2563eb; margin-bottom:4px;">${escapeHtml(r.Dataset || 'No dataset')}</div>
            ${r.DatasetLink ? `<a href="${escapeHtml(r.DatasetLink)}" target="_blank" class="small">üîó View Dataset</a>`
                            : `<span class="small" style="color:#9ca3af;">No link</span>`}
          </td>
          <td style="max-width:260px; word-wrap:break-word;">${escapeHtml(r.Goal)}</td>
          <td>${escapeHtml(r.Teacher)}</td>
          <td>${getStatusBadge(r.Status)}</td>
        </tr>
      `).join('');
    }

    function getStatusBadge(status) {
      const s = (status || 'Booked').toLowerCase();
      if (s.includes('book')) return '<span class="status status-success">Booked</span>';
      if (s.includes('pending')) return '<span class="status status-warning">Pending</span>';
      return `<span class="status status-info">${escapeHtml(status || 'Unknown')}</span>`;
    }

    function escapeHtml(str='') {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // ====== CONFLICT LOGIC (Title, Dataset, Goal) ======
    function classifySimilarity(candidate, row) {
      // Title
      const titleEq = normalize(candidate.TopicTitle) === normalize(row.TopicTitle);
      const titleJac = jaccard(candidate.TopicTitle, row.TopicTitle);
      const titleLev = ratioFromDistance(candidate.TopicTitle, row.TopicTitle);
      let titleLevel = null, titleScore = Math.max(titleJac, titleLev);
      if (titleEq || titleLev >= 0.95) titleLevel = 'exact';
      else if (titleScore >= 0.80) titleLevel = 'high';
      else if (titleScore >= 0.60) titleLevel = 'medium';
      else if (titleScore >= 0.40) titleLevel = 'low';

      // Dataset
      const sameLink = sameUrl(candidate.DatasetLink, row.DatasetLink);
      const sameName = normalize(candidate.Dataset) === normalize(row.Dataset);
      const dsJac = jaccard(candidate.Dataset, row.Dataset);
      let datasetLevel = null, datasetScore = Math.max(dsJac, sameLink ? 1 : 0, sameName ? 1 : 0);
      if (sameLink || sameName) datasetLevel = 'exact';
      else if (sameDomain(candidate.DatasetLink, row.DatasetLink) && dsJac >= 0.5) { datasetLevel = 'high'; datasetScore = Math.max(datasetScore, 0.8); }
      else if (dsJac >= 0.5) datasetLevel = 'medium';
      else if (dsJac >= 0.3) datasetLevel = 'low';

      // Goal
      const goalJac = jaccard(candidate.Goal, row.Goal);
      let goalLevel = null, goalScore = goalJac;
      if (goalJac >= 0.75) goalLevel = 'high';
      else if (goalJac >= 0.55) goalLevel = 'medium';
      else if (goalJac >= 0.35) goalLevel = 'low';

      // Overall severity: exact/high on title or dataset => conflict
      let overall = null, key = 0;
      if (titleLevel === 'exact' || datasetLevel === 'exact') { overall = 'exact'; key = 4; }
      else if (titleLevel === 'high' || datasetLevel === 'high') { overall = 'high'; key = 3; }
      else if (goalLevel === 'high' || titleLevel === 'medium' || datasetLevel === 'medium') { overall = 'medium'; key = 2; }
      else if (goalLevel === 'medium' || titleLevel === 'low' || datasetLevel === 'low') { overall = 'low'; key = 1; }

      const score = Math.max(
        (titleLevel ? titleScore : 0),
        (datasetLevel ? datasetScore : 0),
        (goalLevel ? goalScore : 0)
      );

      return {
        title: { level: titleLevel, score: titleScore },
        dataset: { level: datasetLevel, score: datasetScore, sameLink, sameName },
        goal: { level: goalLevel, score: goalScore },
        overall, score, sortKey: key
      };
    }

    function buildConflictCard(row, sim) {
      function line(label, part) {
        if (!part.level) return '';
        const s = part.score || 0;
        const pctStr = pct(s) + '%';
        return `
          <div class="small" style="display:grid; grid-template-columns:110px 1fr; gap:8px; align-items:center; margin:6px 0;">
            <div><strong>${label}</strong> ${severityBadge(part.level)} <span style="opacity:.8">(${pctStr})</span></div>
            ${scorebar(pct(s))}
          </div>
        `;
      }

      const dsExtras = [];
      if (sim.dataset.sameLink) dsExtras.push('<code>Same URL</code>');
      if (sim.dataset.sameName) dsExtras.push('<code>Same name</code>');

      return `
        <div class="conflict-item">
          <div class="conflict-top">
            <div style="font-weight:700">${escapeHtml(row.TopicTitle || '(no title)')}</div>
            <div>${severityBadge(sim.overall || 'low')}</div>
          </div>
          <div class="small" style="margin-bottom:6px;">
            <span style="opacity:.8">Teacher:</span> ${escapeHtml(row.Teacher || '-')} &nbsp; ‚Ä¢ &nbsp;
            <span style="opacity:.8">Dataset:</span> ${escapeHtml(row.Dataset || '-')} ${row.DatasetLink ? `&nbsp; <a class="small" href="${escapeHtml(row.DatasetLink)}" target="_blank">üîó</a>`:''}
          </div>
          ${line('Title', sim.title)}
          ${line('Dataset', sim.dataset)} ${dsExtras.length ? `<div class="small" style="margin:6px 0 0 0;">${dsExtras.join(' ')}</div>`:''}
          ${line('Goal', sim.goal)}
        </div>
      `;
    }

    async function checkAvailability() {
      checkBtn.innerHTML = '<span class="spinner"></span> Checking...';
      checkBtn.disabled = true;
      conflictsBox.innerHTML = '';
      availabilityNote.innerHTML = '';
      availabilitySummary.innerHTML = '';
      checkResult.classList.remove('hidden');

      try {
        const candidate = {
          TopicTitle: (input.topicTitle.value || '').trim(),
          Dataset: (input.dataset.value || '').trim(),
          DatasetLink: (input.datasetLink.value || '').trim(),
          Goal: (input.goal.value || '').trim()
        };

        if (!candidate.TopicTitle && !candidate.Dataset && !candidate.Goal) {
          availabilityNote.innerHTML = '<div class="status status-warning">Please enter at least a Title, Dataset, or Goal to check.</div>';
          return;
        }

        // Compute similarities against all rows
        const sims = allRows.map(r => {
          const s = classifySimilarity(candidate, r);
          return { r, s };
        });

        // Split into buckets
        const exacts = sims.filter(x => x.s.overall === 'exact').sort((a,b)=>b.s.score - a.s.score);
        const highs  = sims.filter(x => x.s.overall === 'high').sort((a,b)=>b.s.score - a.s.score);
        const meds   = sims.filter(x => x.s.overall === 'medium').sort((a,b)=>b.s.score - a.s.score);
        const lows   = sims.filter(x => x.s.overall === 'low').sort((a,b)=>b.s.score - a.s.score);

        // Summary line
        const totalHits = exacts.length + highs.length + meds.length;
        if (exacts.length) {
          availabilityNote.innerHTML = '<div class="status status-error">‚ùå Conflict: Exact/near-exact match found on Title or Dataset.</div>';
        } else if (highs.length) {
          availabilityNote.innerHTML = '<div class="status status-warning">‚ö†Ô∏è High overlap: similar Title/Dataset detected.</div>';
        } else if (meds.length) {
          availabilityNote.innerHTML = '<div class="status status-warning">‚ö†Ô∏è Possible overlap in Goal or moderately similar Title.</div>';
        } else {
          availabilityNote.innerHTML = '<div class="status status-success">‚úÖ Available ‚Äì no meaningful overlaps found.</div>';
        }
        availabilitySummary.innerHTML =
          `<div class="small">Matches ‚Üí <strong>${exacts.length}</strong> exact, <strong>${highs.length}</strong> high, <strong>${meds.length}</strong> medium.</div>`;

        // Build cards
        function section(title, arr){
          if (!arr.length) return '';
          return `
            <div>
              <div class="small" style="font-weight:700; margin:10px 0 6px 0;">${title}</div>
              ${arr.slice(0, 10).map(x => buildConflictCard(x.r, x.s)).join('')}
            </div>
          `;
        }

        conflictsBox.innerHTML = [
          section('Exact conflicts (Title/Dataset):', exacts),
          section('High similarity:', highs),
          section('Medium similarity:', meds),
          // keep lows hidden by default to reduce noise
        ].join('');

      } catch (error) {
        availabilityNote.innerHTML = `<div class="status status-error">Error: ${error.message}</div>`;
      } finally {
        checkBtn.innerHTML = 'Check Availability';
        checkBtn.disabled = false;
      }
    }

    // ====== ADD BOOKING ======
    async function addBooking() {
      const studentIdValue = (input.studentId.value || '').trim();
      if (studentIdValue && !validateStudentId(studentIdValue)) {
        addStatus.innerHTML = '<div class="status status-error">‚ùå Invalid Student ID format</div>';
        return;
      }

      addBtn.innerHTML = '<span class="spinner"></span> Adding...';
      addBtn.disabled = true;
      addStatus.textContent = '';

      try {
        const payload = {
          [SHEET_COLUMNS.STUDENT_NAME]: input.studentName.value.trim(),
          [SHEET_COLUMNS.STUDENT_ID]: input.studentId.value.trim(),
          [SHEET_COLUMNS.TOPIC_TITLE]: input.topicTitle.value.trim(),
          [SHEET_COLUMNS.DATASET_NAME]: input.dataset.value.trim(),
          [SHEET_COLUMNS.DATASET_LINK]: input.datasetLink.value.trim(),
          [SHEET_COLUMNS.GOAL]: input.goal.value.trim(),
          [SHEET_COLUMNS.TEACHER]: input.teacher.value,
          [SHEET_COLUMNS.STATUS]: 'Booked'
        };

        if (!payload[SHEET_COLUMNS.STUDENT_NAME] || !payload[SHEET_COLUMNS.TOPIC_TITLE] || !payload[SHEET_COLUMNS.TEACHER]) {
          throw new Error('Please fill required fields: Student Name, Topic Title, Teacher');
        }

        const formData = new FormData();
        formData.append('token', API_TOKEN);
        formData.append('data', JSON.stringify(payload));

        const res = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        if (!data || !data.ok) throw new Error('Unexpected response format');

        addStatus.innerHTML = '<div class="status status-success">‚úÖ Added successfully</div>';
        // Clear form
        Object.values(input).forEach(el => { if (el.tagName === 'SELECT') el.selectedIndex = 0; else el.value = ''; });
        // Refresh list
        await loadRows();
        // Hide check results
        checkResult.classList.add('hidden');

      } catch (err) {
        addStatus.innerHTML = `<div class="status status-error">‚ùå Error: ${err.message}</div>`;
      } finally {
        addBtn.innerHTML = 'Add to Sheet';
        addBtn.disabled = false;
      }
    }

    // ====== INIT ======
    loadRows();
  </script>
</body>
</html>
