<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Undergrad Topic Booking</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.6;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .header {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .header h1 {
      font-size: 24px;
      color: #2563eb;
      margin-bottom: 5px;
    }
    
    .header p {
      color: #666;
      margin-bottom: 15px;
    }
    
    .card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .card h2 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #333;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    
    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #333;
    }
    
    input, textarea, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #2563eb;
    }
    
    input.error {
      border-color: #ef4444;
    }
    
    .error-message {
      color: #ef4444;
      font-size: 12px;
      margin-top: 5px;
    }
    
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .btn {
      background-color: #2563eb;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }
    
    .btn:hover {
      background-color: #1d4ed8;
    }
    
    .btn:disabled {
      background-color: #94a3b8;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      background-color: #6b7280;
    }
    
    .btn-secondary:hover {
      background-color: #4b5563;
    }
    
    .btn-full {
      width: 100%;
    }
    
    .status {
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 500;
      display: inline-block;
    }
    
    .status-success {
      background-color: #dcfce7;
      color: #166534;
    }
    
    .status-error {
      background-color: #fee2e2;
      color: #991b1b;
    }
    
    .status-warning {
      background-color: #fef3c7;
      color: #92400e;
    }
    
    .filters {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    
    .filters input {
      flex: 1;
      min-width: 150px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    
    table th {
      background-color: #f8f9fa;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid #e5e7eb;
    }
    
    table td {
      padding: 12px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    table tr:hover {
      background-color: #f8f9fa;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }
    
    .conflicts {
      margin-top: 15px;
    }
    
    .conflict-item {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background-color: #f9fafb;
    }
    
    .conflict-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .conflict-title {
      font-weight: 600;
      color: #1f2937;
      font-size: 14px;
    }
    
    .conflict-score {
      font-size: 12px;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 12px;
    }
    
    .score-high {
      background-color: #fee2e2;
      color: #991b1b;
    }
    
    .score-medium {
      background-color: #fef3c7;
      color: #92400e;
    }
    
    .score-low {
      background-color: #dbeafe;
      color: #1e40af;
    }
    
    .conflict-details {
      font-size: 13px;
      color: #555;
      line-height: 1.5;
    }
    
    .similarity-breakdown {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    
    .similarity-item {
      background: white;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
    }
    
    .similarity-label {
      font-weight: 500;
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 3px;
    }
    
    .similarity-value {
      font-size: 13px;
      font-weight: 600;
    }
    
    .similarity-match {
      color: #dc2626;
    }
    
    .similarity-partial {
      color: #d97706;
    }
    
    .similarity-none {
      color: #059669;
    }
    
    .layout {
      display: grid;
      grid-template-columns: 400px 1fr;
      gap: 20px;
    }
    
    @media (max-width: 1024px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }
    
    .hidden {
      display: none;
    }
    
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #2563eb;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    code {
      background-color: #f3f4f6;
      padding: 2px 4px;
      border-radius: 3px;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 12px;
    }

    .conflict-summary {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }

    .summary-item {
      text-align: center;
      padding: 8px;
      border-radius: 6px;
      background: white;
    }

    .summary-number {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 2px;
    }

    .summary-label {
      font-size: 11px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* NEW: Duplicate alert styling */
    .duplicate-alert {
      background: #fef2f2;
      border: 2px solid #fca5a5;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }

    .duplicate-alert h4 {
      color: #991b1b;
      margin-bottom: 8px;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .duplicate-alert .student-info {
      background: white;
      padding: 10px;
      border-radius: 6px;
      border-left: 4px solid #dc2626;
    }

    .duplicate-alert .student-info strong {
      color: #991b1b;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Undergrad Topic Booking</h1>
      <p>Manage student research topics with enhanced conflict detection and duplicate prevention</p>
      <button id="refreshBtn" class="btn btn-secondary">‚Üª Refresh Data</button>
    </div>

    <div class="layout">
      <!-- Left column -->
      <div>
        <!-- Check Section -->
        <div class="card">
          <h2>Check Availability</h2>
          
          <div class="form-row">
            <div class="form-group">
              <label>Student Name</label>
              <input id="studentName" placeholder="e.g., Alex" />
            </div>
            <div class="form-group">
              <label>Student ID (CDU)</label>
              <input id="studentId" placeholder="2021xxxxxxxx" maxlength="12" />
              <div id="studentIdError" class="error-message hidden">Student ID must be 12 digits starting with 2021</div>
            </div>
          </div>

          <div class="form-group">
            <label>Topic Title</label>
            <input id="topicTitle" placeholder="Short descriptive title" />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Dataset Name</label>
              <input id="dataset" placeholder="e.g., UCI Credit" />
            </div>
            <div class="form-group">
              <label>Dataset URL</label>
              <input id="datasetLink" type="url" placeholder="https://..." />
            </div>
          </div>

          <div class="form-group">
            <label>Research Goal</label>
            <textarea id="goal" placeholder="Describe the research objective"></textarea>
          </div>

          <div class="form-group">
            <label>Supervisor</label>
            <select id="teacher">
              <option value="">Select Supervisor</option>
              <option value="Cezar">Cezar</option>
              <option value="Gladys">Gladys</option>
              <option value="IJ">IJ</option>
              <option value="Isaac">Isaac</option>
              <option value="James">James</option>
              <option value="Javed">Javed</option>
              <option value="Joao">Joao</option>
              <option value="Linda">Linda</option>
              <option value="Martin">Martin</option>
              <option value="Meropi">Meropi</option>
              <option value="Pedro">Pedro</option>
              <option value="Stacy">Stacy</option>
              <option value="Taha">Taha</option>
              <option value="Yuefei">Yuefei</option>
              <option value="Zaid">Zaid</option>
            </select>
          </div>

          <button id="checkBtn" class="btn btn-full">Check Availability</button>

          <div id="checkResult" class="hidden">
            <div id="availabilityNote" style="margin-top: 15px;"></div>
            <div id="duplicateAlert"></div>
            <div id="conflicts"></div>
          </div>
        </div>

        <!-- Add Section -->
        <div class="card">
          <h2>Add Booking</h2>
          <p style="margin-bottom: 15px; color: #666;">Submit your topic if it's available.</p>
          
          <button id="addBtn" class="btn btn-full">Add to Sheet</button>
          <div id="addStatus" style="margin-top: 10px; text-align: center;"></div>
        </div>
      </div>

      <!-- Right column -->
      <div class="card">
        <h2>Current Bookings</h2>
        
        <div class="filters">
          <input id="filterText" placeholder="Search..." />
          <input id="filterTeacher" placeholder="Filter by Teacher" />
          <button id="clearFilters" class="btn btn-secondary">Clear</button>
        </div>

        <div style="overflow-x: auto;">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Student</th>
                <th>Topic</th>
                <th>Dataset</th>
                <th>Goal</th>
                <th>Teacher</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxv7iau-cZ0iF29D3EaFehf0q5xoBJ2iOV0O7Pz2R_-bxRZDnt3S9DY1-jGDtiK0iKaLg/exec';
    const API_TOKEN = 'my-secret-123';

    // Sheet column mapping constants
    const SHEET_COLUMNS = {
      STUDENT_NAME: 'StudentName',
      STUDENT_ID: 'StudentID',
      TOPIC_TITLE: 'TopicTitle',
      DATASET_NAME: 'Dataset Name',    
      DATASET_LINK: 'Dataset Link',    
      GOAL: 'Goal',
      TEACHER: 'Teacher',
      STATUS: 'Status',
      TIMESTAMP: 'Timestamp'
    };

    // Elements
    const input = {
      studentName: document.getElementById('studentName'),
      studentId: document.getElementById('studentId'),
      topicTitle: document.getElementById('topicTitle'),
      dataset: document.getElementById('dataset'),
      datasetLink: document.getElementById('datasetLink'),
      goal: document.getElementById('goal'),
      teacher: document.getElementById('teacher'),
    };

    const checkBtn = document.getElementById('checkBtn');
    const checkResult = document.getElementById('checkResult');
    const availabilityNote = document.getElementById('availabilityNote');
    const duplicateAlert = document.getElementById('duplicateAlert');
    const conflictsBox = document.getElementById('conflicts');
    const addBtn = document.getElementById('addBtn');
    const addStatus = document.getElementById('addStatus');
    const filterText = document.getElementById('filterText');
    const filterTeacher = document.getElementById('filterTeacher');
    const clearFilters = document.getElementById('clearFilters');
    const rowsTbody = document.getElementById('rows');
    const studentIdError = document.getElementById('studentIdError');

    let allRows = [];

    // NEW: Check for duplicate student ID
    function checkDuplicateStudentId(studentId) {
      if (!studentId || !studentId.trim()) return null;
      
      const normalizedId = studentId.trim();
      const duplicate = allRows.find(row => 
        row.StudentID && row.StudentID.trim() === normalizedId
      );
      
      return duplicate || null;
    }

    // Enhanced similarity calculation
    function calculateSimilarity(str1, str2) {
      if (!str1 || !str2) return 0;
      
      str1 = str1.toLowerCase().trim();
      str2 = str2.toLowerCase().trim();
      
      // Exact match
      if (str1 === str2) return 100;
      
      // Calculate Jaccard similarity for words
      const words1 = new Set(str1.split(/\s+/).filter(w => w.length > 2));
      const words2 = new Set(str2.split(/\s+/).filter(w => w.length > 2));
      
      if (words1.size === 0 && words2.size === 0) return 0;
      
      const intersection = new Set([...words1].filter(w => words2.has(w)));
      const union = new Set([...words1, ...words2]);
      
      const jaccardSimilarity = intersection.size / union.size;
      
      // Check for substring matches
      const substringMatch = str1.includes(str2) || str2.includes(str1);
      
      // Combine scores
      let similarity = jaccardSimilarity * 100;
      if (substringMatch && similarity < 50) {
        similarity = Math.max(similarity, 40);
      }
      
      return Math.round(similarity);
    }

    // Enhanced conflict analysis
    function analyzeConflicts(newRow, existingRow) {
      const titleSimilarity = calculateSimilarity(newRow.TopicTitle, existingRow.TopicTitle);
      const datasetSimilarity = calculateSimilarity(newRow.Dataset, existingRow.Dataset);
      const goalSimilarity = calculateSimilarity(newRow.Goal, existingRow.Goal);
      
      // Check for exact dataset URL match
      const urlMatch = newRow.DatasetLink && existingRow.DatasetLink && 
                      newRow.DatasetLink.trim() === existingRow.DatasetLink.trim();
      
      if (urlMatch) {
        return {
          titleSimilarity,
          datasetSimilarity: 100,
          goalSimilarity,
          urlMatch: true,
          overallRisk: 'high',
          maxSimilarity: 100
        };
      }
      
      const maxSimilarity = Math.max(titleSimilarity, datasetSimilarity, goalSimilarity);
      
      let overallRisk = 'low';
      if (maxSimilarity >= 80 || (titleSimilarity >= 60 && datasetSimilarity >= 60)) {
        overallRisk = 'high';
      } else if (maxSimilarity >= 50 || (titleSimilarity >= 40 && goalSimilarity >= 40)) {
        overallRisk = 'medium';
      }
      
      return {
        titleSimilarity,
        datasetSimilarity,
        goalSimilarity,
        urlMatch: false,
        overallRisk,
        maxSimilarity
      };
    }

    // Student ID validation
    function validateStudentId(value) {
      const pattern = /^2021\d{8}$/;
      return pattern.test(value);
    }

    // Event listeners
    document.getElementById('refreshBtn').addEventListener('click', loadRows);
    clearFilters.addEventListener('click', () => {
      filterText.value = '';
      filterTeacher.value = '';
      renderRows();
    });
    filterText.addEventListener('input', renderRows);
    filterTeacher.addEventListener('input', renderRows);
    checkBtn.addEventListener('click', checkAvailability);
    addBtn.addEventListener('click', addBooking);

    // Student ID validation on input
    input.studentId.addEventListener('input', function() {
      const value = this.value.trim();
      if (value && !validateStudentId(value)) {
        this.classList.add('error');
        studentIdError.classList.remove('hidden');
      } else {
        this.classList.remove('error');
        studentIdError.classList.add('hidden');
      }
    });

    // Load data
    async function loadRows() {
      rowsTbody.innerHTML = '<tr><td colspan="7" class="loading">Loading...</td></tr>';
      
      try {
        const url = `${SCRIPT_URL}?action=list&token=${encodeURIComponent(API_TOKEN)}`;
        const res = await fetch(url);
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const data = await res.json();
        
        if (data.error) {
          throw new Error(data.error);
        }
        
        allRows = (data.rows || []).map((r, idx) => ({
          idx,
          Timestamp: r[SHEET_COLUMNS.TIMESTAMP] ? new Date(r[SHEET_COLUMNS.TIMESTAMP]) : '',
          StudentName: r[SHEET_COLUMNS.STUDENT_NAME] || '',
          StudentID: r[SHEET_COLUMNS.STUDENT_ID] || '',
          TopicTitle: r[SHEET_COLUMNS.TOPIC_TITLE] || '',
          Dataset: (r[SHEET_COLUMNS.DATASET_NAME]  || ''),
          DatasetLink: (r[SHEET_COLUMNS.DATASET_LINK] || ''),
          Goal: r[SHEET_COLUMNS.GOAL] || '',
          Teacher: r[SHEET_COLUMNS.TEACHER] || '',
          Status: r[SHEET_COLUMNS.STATUS] || 'Booked'
        }));
        
        renderRows();
      } catch (err) {
        rowsTbody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: #ef4444; padding: 20px;">Error: ${err.message}</td></tr>`;
      }
    }

    // Render table rows
    function renderRows() {
      const searchText = filterText.value.toLowerCase();
      const teacherFilter = filterTeacher.value.toLowerCase();
      
      const filtered = allRows.filter(r => {
        const searchTarget = `${r.StudentName} ${r.TopicTitle} ${r.Dataset} ${r.Goal} ${r.Teacher}`.toLowerCase();
        const matchesSearch = !searchText || searchTarget.includes(searchText);
        const matchesTeacher = !teacherFilter || r.Teacher.toLowerCase().includes(teacherFilter);
        return matchesSearch && matchesTeacher;
      });

      if (filtered.length === 0) {
        rowsTbody.innerHTML = '<tr><td colspan="7" class="empty-state">No bookings found</td></tr>';
        return;
      }

      rowsTbody.innerHTML = filtered.map((r, i) => `
        <tr>
          <td>${i + 1}</td>
          <td>
            <div style="font-weight: 500;">${escapeHtml(r.StudentName)}</div>
            <div style="font-size: 12px; color: #666;">ID: ${escapeHtml(r.StudentID)}</div>
          </td>
          <td>${escapeHtml(r.TopicTitle)}</td>
          <td>
            <div style="font-weight: 500; color: #2563eb; margin-bottom: 4px;">${escapeHtml(r.Dataset || 'No dataset specified')}</div>
            ${r.DatasetLink ? `
              <a href="${escapeHtml(r.DatasetLink)}" target="_blank" style="color: #059669; font-size: 12px; text-decoration: none; display: inline-flex; align-items: center; gap: 2px;">
                üîó View Dataset
              </a>
            ` : '<span style="color: #9ca3af; font-size: 12px;">No link provided</span>'}
          </td>
          <td style="max-width: 200px; word-wrap: break-word;">${escapeHtml(r.Goal)}</td>
          <td>${escapeHtml(r.Teacher)}</td>
          <td>${getStatusBadge(r.Status)}</td>
        </tr>
      `).join('');
    }

    // Status badge
    function getStatusBadge(status) {
      const s = (status || 'Booked').toLowerCase();
      if (s.includes('book')) return '<span class="status status-success">Booked</span>';
      if (s.includes('pending')) return '<span class="status status-warning">Pending</span>';
      return `<span class="status status-warning">${escapeHtml(status || 'Unknown')}</span>`;
    }

    // Escape HTML
    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // Enhanced availability check with duplicate detection
    async function checkAvailability() {
      checkBtn.innerHTML = '<span class="spinner"></span>Checking...';
      checkBtn.disabled = true;
      
      availabilityNote.innerHTML = '';
      duplicateAlert.innerHTML = '';
      conflictsBox.innerHTML = '';
      checkResult.classList.remove('hidden');

      try {
        const studentIdValue = input.studentId.value.trim();
        
        // FIRST: Check for duplicate student ID
        let hasDuplicate = false;
        if (studentIdValue) {
          const duplicate = checkDuplicateStudentId(studentIdValue);
          if (duplicate) {
            hasDuplicate = true;
            duplicateAlert.innerHTML = `
              <div class="duplicate-alert">
                <h4>‚ö†Ô∏è Student ID Already Registered</h4>
                <p style="margin-bottom: 10px;">This Student ID has already been used for a booking:</p>
                <div class="student-info">
                  <p><strong>Student:</strong> ${escapeHtml(duplicate.StudentName)}</p>
                  <p><strong>Topic:</strong> ${escapeHtml(duplicate.TopicTitle)}</p>
                  <p><strong>Dataset:</strong> ${escapeHtml(duplicate.Dataset)}</p>
                  <p><strong>Supervisor:</strong> ${escapeHtml(duplicate.Teacher)}</p>
                  <p><strong>Status:</strong> ${escapeHtml(duplicate.Status)}</p>
                </div>
                <p style="margin-top: 10px; color: #991b1b; font-weight: 500;">
                  ‚ùå Cannot create multiple bookings with the same Student ID.
                </p>
              </div>
            `;
            
            availabilityNote.innerHTML = '<div class="status status-error">‚ùå Student ID already exists - cannot proceed with booking</div>';
            return; // Stop here if duplicate found
          }
        }

        // SECOND: Check for topic/dataset conflicts (only if no duplicate)
        const candidate = {
          TopicTitle: input.topicTitle.value.trim(),
          Dataset: input.dataset.value.trim(),
          DatasetLink: input.datasetLink.value.trim(),
          Goal: input.goal.value.trim()
        };

        if (!candidate.TopicTitle && !candidate.Dataset && !candidate.Goal) {
          if (studentIdValue) {
            availabilityNote.innerHTML = '<div class="status status-success">‚úÖ Student ID is available</div>';
          } else {
            availabilityNote.innerHTML = '<div class="status status-warning">Please enter topic, dataset, or goal to check for conflicts</div>';
          }
          return;
        }

        // Analyze all conflicts
        let conflicts = [];
        for (const r of allRows) {
          const analysis = analyzeConflicts(candidate, r);
          if (analysis.maxSimilarity > 15) { // Only show meaningful similarities
            conflicts.push({ row: r, analysis });
          }
        }

        // Sort by risk and similarity
        conflicts.sort((a, b) => {
          const riskOrder = { high: 3, medium: 2, low: 1 };
          const riskDiff = riskOrder[b.analysis.overallRisk] - riskOrder[a.analysis.overallRisk];
          if (riskDiff !== 0) return riskDiff;
          return b.analysis.maxSimilarity - a.analysis.maxSimilarity;
        });

        // Categorize conflicts
        const highRisk = conflicts.filter(c => c.analysis.overallRisk === 'high');
        const mediumRisk = conflicts.filter(c => c.analysis.overallRisk === 'medium');
        const lowRisk = conflicts.filter(c => c.analysis.overallRisk === 'low');

        // Display overall status
        let statusMessage = '';
        if (studentIdValue) {
          statusMessage += '‚úÖ Student ID is available. ';
        }

        if (highRisk.length > 0) {
          availabilityNote.innerHTML = `<div class="status status-error">${statusMessage}‚ùå High conflict risk - similar topics found</div>`;
        } else if (mediumRisk.length > 0) {
          availabilityNote.innerHTML = `<div class="status status-warning">${statusMessage}‚ö†Ô∏è Moderate conflict risk - potential overlaps detected</div>`;
        } else if (lowRisk.length > 0) {
          availabilityNote.innerHTML = `<div class="status status-warning">${statusMessage}üí° Minor similarities found - review recommended</div>`;
        } else {
          availabilityNote.innerHTML = `<div class="status status-success">${statusMessage}‚úÖ No conflicts detected - topic appears available</div>`;
        }

        // Display conflict details
        if (conflicts.length > 0) {
          const summary = `
            <div class="conflict-summary">
              <div class="summary-grid">
                <div class="summary-item">
                  <div class="summary-number" style="color: #dc2626;">${highRisk.length}</div>
                  <div class="summary-label">High Risk</div>
                </div>
                <div class="summary-item">
                  <div class="summary-number" style="color: #d97706;">${mediumRisk.length}</div>
                  <div class="summary-label">Medium Risk</div>
                </div>
                <div class="summary-item">
                  <div class="summary-number" style="color: #0369a1;">${lowRisk.length}</div>
                  <div class="summary-label">Low Risk</div>
                </div>
                <div class="summary-item">
                  <div class="summary-number" style="color: #059669;">${allRows.length - conflicts.length}</div>
                  <div class="summary-label">No Conflict</div>
                </div>
              </div>
            </div>
          `;

          const conflictDetails = conflicts.slice(0, 10).map(({row, analysis}) => {
            const scoreClass = analysis.overallRisk === 'high' ? 'score-high' : 
                             analysis.overallRisk === 'medium' ? 'score-medium' : 'score-low';
            
            return `
              <div class="conflict-item">
                <div class="conflict-header">
                  <div class="conflict-title">${escapeHtml(row.TopicTitle)}</div>
                  <div class="conflict-score ${scoreClass}">
                    ${analysis.overallRisk.toUpperCase()} RISK (${analysis.maxSimilarity}%)
                  </div>
                </div>
                <div class="conflict-details">
                  <strong>Student:</strong> ${escapeHtml(row.StudentName)} (ID: ${escapeHtml(row.StudentID)})<br>
                  <strong>Teacher:</strong> ${escapeHtml(row.Teacher)}<br>
                  <strong>Dataset:</strong> ${escapeHtml(row.Dataset)}
                  ${analysis.urlMatch ? ' <span style="color: #dc2626; font-weight: 600;">(EXACT URL MATCH)</span>' : ''}
                </div>
                <div class="similarity-breakdown">
                  <div class="similarity-item">
                    <div class="similarity-label">Topic Title</div>
                    <div class="similarity-value ${getSimilarityClass(analysis.titleSimilarity)}">
                      ${analysis.titleSimilarity}% match
                    </div>
                  </div>
                  <div class="similarity-item">
                    <div class="similarity-label">Dataset</div>
                    <div class="similarity-value ${getSimilarityClass(analysis.datasetSimilarity)}">
                      ${analysis.datasetSimilarity}% match
                    </div>
                  </div>
                  <div class="similarity-item">
                    <div class="similarity-label">Research Goal</div>
                    <div class="similarity-value ${getSimilarityClass(analysis.goalSimilarity)}">
                      ${analysis.goalSimilarity}% match
                    </div>
                  </div>
                </div>
              </div>
            `;
          }).join('');

          const conflictAnalysisSection = conflicts.length > 0 ? `
            <h4 style="margin-bottom: 15px;">Detailed Conflict Analysis:</h4>
            ${conflictDetails}
            ${conflicts.length > 10 ? `<p style="text-align: center; color: #666; margin-top: 10px;">Showing top 10 of ${conflicts.length} potential conflicts</p>` : ''}
          ` : `
            <p style="text-align: center; color: #059669; font-weight: 500; margin-top: 15px;">
              üéâ No conflicts detected! Your topic appears to be unique.
            </p>
          `;

          conflictsBox.innerHTML = `
            <div class="conflicts">
              ${summary}
              ${conflictAnalysisSection}
            </div>
          `;
        }

      } catch (error) {
        availabilityNote.innerHTML = `<div class="status status-error">Error: ${error.message}</div>`;
      } finally {
        checkBtn.innerHTML = 'Check Availability';
        checkBtn.disabled = false;
      }
    }

    function getSimilarityClass(similarity) {
      if (similarity >= 70) return 'similarity-match';
      if (similarity >= 30) return 'similarity-partial';
      return 'similarity-none';
    }

    // Enhanced add booking with duplicate prevention
    async function addBooking() {
      // Validate Student ID format
      const studentIdValue = input.studentId.value.trim();
      if (studentIdValue && !validateStudentId(studentIdValue)) {
        addStatus.innerHTML = '<div class="status status-error">‚ùå Invalid Student ID format</div>';
        return;
      }

      // Check for duplicate Student ID before submission
      if (studentIdValue) {
        const duplicate = checkDuplicateStudentId(studentIdValue);
        if (duplicate) {
          addStatus.innerHTML = `
            <div class="status status-error">
              ‚ùå Student ID ${studentIdValue} is already registered to ${duplicate.StudentName}. 
              Cannot create duplicate booking.
            </div>
          `;
          return;
        }
      }

      addBtn.innerHTML = '<span class="spinner"></span>Adding...';
      addBtn.disabled = true;
      addStatus.textContent = '';

      try {
        // Collect form data into payload object using SHEET_COLUMNS constants
        const payload = {
          [SHEET_COLUMNS.STUDENT_NAME]: input.studentName.value.trim(),
          [SHEET_COLUMNS.STUDENT_ID]: input.studentId.value.trim(),
          [SHEET_COLUMNS.TOPIC_TITLE]: input.topicTitle.value.trim(),
          [SHEET_COLUMNS.DATASET_NAME]: input.dataset.value.trim(),
          [SHEET_COLUMNS.DATASET_LINK]: input.datasetLink.value.trim(),
          [SHEET_COLUMNS.GOAL]: input.goal.value.trim(),
          [SHEET_COLUMNS.TEACHER]: input.teacher.value,
          [SHEET_COLUMNS.STATUS]: 'Booked'
        };

        if (!payload[SHEET_COLUMNS.STUDENT_NAME] || !payload[SHEET_COLUMNS.TOPIC_TITLE] || !payload[SHEET_COLUMNS.TEACHER]) {
          throw new Error('Please fill in required fields: Student Name, Topic Title, and Teacher');
        }

        const formData = new FormData();
        formData.append('token', API_TOKEN);
        formData.append('data', JSON.stringify(payload));

        const res = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: formData
        });

        const data = await res.json();
        
        if (data.error) {
          throw new Error(data.error);
        }
        
        if (data && data.ok) {
          addStatus.innerHTML = '<div class="status status-success">‚úÖ Added successfully</div>';
          
          // Clear form
          Object.values(input).forEach(el => {
            if (el.tagName === 'SELECT') {
              el.selectedIndex = 0;
            } else {
              el.value = '';
            }
          });
          
          // Refresh data
          await loadRows();
          
          // Hide check results
          checkResult.classList.add('hidden');
        } else {
          throw new Error('Unexpected response format');
        }
      } catch (err) {
        addStatus.innerHTML = `<div class="status status-error">‚ùå Error: ${err.message}</div>`;
      } finally {
        addBtn.innerHTML = 'Add to Sheet';
        addBtn.disabled = false;
      }
    }

    // Test function for debugging duplicate detection
    window.testDuplicateCheck = function() {
      console.log('üß™ TESTING DUPLICATE CHECK SYSTEM');
      console.log('üìä Current data state:');
      console.log('  - Total rows loaded:', allRows.length);
      console.log('  - Sample rows:', allRows.slice(0, 3));
      
      const testId = input.studentId.value.trim();
      console.log('üîç Testing Student ID:', testId);
      
      if (!testId) {
        alert('Please enter a Student ID to test');
        return;
      }
      
      const duplicate = checkDuplicateStudentId(testId);
      
      if (duplicate) {
        alert(`üö® DUPLICATE FOUND!\nStudent: ${duplicate.StudentName}\nTopic: ${duplicate.TopicTitle}\nTeacher: ${duplicate.Teacher}`);
      } else {
        alert('‚úÖ No duplicate found - this Student ID is available');
      }
    };

    // Initialize
    loadRows();
  </script>
</body>
</html>
